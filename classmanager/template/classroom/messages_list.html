{% extends 'classroom/base.html' %}
{% load static %}
{% block content %}

<div class="messages-dashboard">
  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="page-title">Student Messages</h1>
      <p class="page-subtitle">Communications from your students</p>
      <div class="header-stats">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-envelope"></i>
          </div>
          <div class="stat-info">
            <span class="stat-number">{{ teacher.messages.count }}</span>
            <span class="stat-label">Total Messages</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <span class="stat-number">{{ teacher.messages.count }}</span>
            <span class="stat-label">Unread</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <span class="stat-number">{{ teacher.students.count }}</span>
            <span class="stat-label">Students</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="messages-content">
    {% if teacher.messages.count == 0 %}
    <!-- Empty State -->
    <div class="empty-state">
      <div class="empty-illustration">
        <i class="fas fa-comments"></i>
      </div>
      <h3>No Messages Yet</h3>
      <p>Your students haven't sent any messages yet. When they do, you'll see them here.</p>
      <div class="empty-actions">
        <button class="btn btn-primary" onclick="location.reload()">
          <i class="fas fa-sync"></i> Refresh
        </button>
      </div>
    </div>
    {% else %}
    <!-- Messages List -->
    <div class="messages-list">
      <!-- Filters and Search -->
      <div class="messages-toolbar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search messages..." id="searchInput">
        </div>
        <div class="filter-options">
          <select class="filter-select" id="filterSelect">
            <option value="all">All Messages</option>
            <option value="unread">Unread</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
          </select>
          <button class="btn btn-outline" id="refreshBtn">
            <i class="fas fa-sync"></i>
          </button>
        </div>
      </div>

      <!-- Messages Grid -->
      <div class="messages-grid">
        {% for mssg in teacher.messages.all %}
        <div class="message-card" data-message-id="{{ mssg.id }}">
          <div class="card-header">
            <div class="student-info">
              <div class="student-avatar">
                {% if mssg.student.student_profile_pic %}
                <img src="{{ mssg.student.student_profile_pic.url }}" alt="{{ mssg.student.name }}">
                {% else %}
                <img src="{% static 'images/login-avatar.PNG' %}" alt="Default Avatar">
                {% endif %}
                <div class="status-indicator online"></div>
              </div>
              <div class="student-details">
                <h4 class="student-name">{{ mssg.student.name }}</h4>
                <span class="message-time">
                  <i class="fas fa-clock"></i>
                  {{ mssg.created_at|timesince }} ago
                </span>
              </div>
            </div>
            <div class="message-actions">
              <div class="dropdown">
                <button class="action-btn">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-menu">
                  <button class="dropdown-item" onclick="replyToMessage('{{ mssg.student.name }}', {{ mssg.id }})">
                    <i class="fas fa-reply"></i> Reply
                  </button>
                  <button class="dropdown-item" onclick="markAsRead({{ mssg.id }})">
                    <i class="fas fa-check"></i> Mark as Read
                  </button>
                  <div class="dropdown-divider"></div>
                  <button class="dropdown-item text-danger" onclick="deleteMessage({{ mssg.id }})">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="card-body">
            <div class="message-content">
              {{ mssg.message_html|safe }}
            </div>
          </div>

          <div class="card-footer">
            <div class="message-meta">
              <span class="badge badge-primary">Student</span>
              <span class="message-id">#{{ forloop.counter }}</span>
            </div>
            <div class="quick-actions">
              <button class="quick-btn" onclick="quickReply({{ mssg.id }})" title="Quick Reply">
                <i class="fas fa-reply"></i>
              </button>
              <button class="quick-btn" onclick="saveMessage({{ mssg.id }})" title="Save Message">
                <i class="fas fa-bookmark"></i>
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Load More -->
      <div class="load-more">
        <button class="btn btn-outline" id="loadMoreBtn">
          <i class="fas fa-chevron-down"></i> Load More Messages
        </button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Reply Modal -->
<div class="modal" id="replyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Reply to Student</h3>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <form id="replyForm">
        <div class="form-group">
          <label>To:</label>
          <input type="text" id="replyTo" class="form-control" readonly>
        </div>
        <div class="form-group">
          <label>Message:</label>
          <textarea class="form-control" rows="6" placeholder="Type your reply here..."></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeReplyModal()">Cancel</button>
      <button class="btn btn-primary" onclick="sendReply()">Send Reply</button>
    </div>
  </div>
</div>

<style>
/* Modern CSS Variables */
:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --secondary: #6c757d;
  --success: #28a745;
  --danger: #dc3545;
  --warning: #ffc107;
  --light: #f8f9fa;
  --dark: #343a40;
  --border: #e9ecef;
  --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  --radius: 12px;
  --transition: all 0.3s ease;
}

/* Base Styles */
.messages-dashboard {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7ff 0%, #f0f4ff 100%);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Header Styles */
.dashboard-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  padding: 2rem 0;
  margin-bottom: 2rem;
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem;
}

.page-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.page-subtitle {
  font-size: 1.1rem;
  opacity: 0.9;
  margin-bottom: 2rem;
}

.header-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.stat-card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: var(--radius);
  padding: 1.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: var(--transition);
}

.stat-card:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
}

.stat-icon {
  width: 50px;
  height: 50px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.stat-info {
  display: flex;
  flex-direction: column;
}

.stat-number {
  font-size: 1.8rem;
  font-weight: 700;
  line-height: 1;
}

.stat-label {
  font-size: 0.9rem;
  opacity: 0.8;
}

/* Main Content */
.messages-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem 2rem;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.empty-illustration {
  font-size: 4rem;
  color: var(--primary);
  margin-bottom: 1.5rem;
  opacity: 0.7;
}

.empty-state h3 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
  color: var(--dark);
}

.empty-state p {
  color: var(--secondary);
  margin-bottom: 2rem;
  font-size: 1.1rem;
}

.empty-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
}

/* Messages List */
.messages-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  gap: 1rem;
  flex-wrap: wrap;
}

.search-box {
  position: relative;
  flex: 1;
  min-width: 300px;
}

.search-box i {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--secondary);
}

.search-box input {
  width: 100%;
  padding: 0.75rem 1rem 0.75rem 3rem;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  font-size: 1rem;
  transition: var(--transition);
}

.search-box input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.filter-options {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.filter-select {
  padding: 0.75rem 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  background: white;
  font-size: 1rem;
  cursor: pointer;
}

/* Messages Grid */
.messages-grid {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
}

.message-card {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  transition: var(--transition);
  border: 1px solid var(--border);
  overflow: hidden;
}

.message-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.card-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
}

.student-info {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  flex: 1;
}

.student-avatar {
  position: relative;
  width: 50px;
  height: 50px;
  flex-shrink: 0;
}

.student-avatar img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.status-indicator {
  position: absolute;
  bottom: 2px;
  right: 2px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid white;
}

.status-indicator.online {
  background: var(--success);
}

.status-indicator.offline {
  background: var(--secondary);
}

.student-details {
  flex: 1;
}

.student-name {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: var(--dark);
}

.message-time {
  font-size: 0.85rem;
  color: var(--secondary);
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.message-actions {
  position: relative;
}

.action-btn {
  background: none;
  border: none;
  color: var(--secondary);
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 6px;
  transition: var(--transition);
}

.action-btn:hover {
  background: var(--light);
  color: var(--dark);
}

/* Dropdown Menu */
.dropdown {
  position: relative;
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: var(--radius);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  padding: 0.5rem 0;
  min-width: 160px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: var(--transition);
}

.dropdown:hover .dropdown-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item {
  width: 100%;
  background: none;
  border: none;
  padding: 0.75rem 1rem;
  text-align: left;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--dark);
}

.dropdown-item:hover {
  background: var(--light);
}

.dropdown-item.text-danger {
  color: var(--danger);
}

.dropdown-divider {
  height: 1px;
  background: var(--border);
  margin: 0.5rem 0;
}

/* Card Body */
.card-body {
  padding: 1.5rem;
}

.message-content {
  color: var(--dark);
  line-height: 1.6;
  font-size: 1rem;
}

.message-content strong {
  color: var(--primary);
  font-weight: 600;
}

.message-content em {
  color: var(--secondary);
  font-style: italic;
}

/* Card Footer */
.card-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--light);
}

.message-meta {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-primary {
  background: rgba(67, 97, 238, 0.1);
  color: var(--primary);
}

.message-id {
  font-size: 0.85rem;
  color: var(--secondary);
  font-weight: 600;
}

.quick-actions {
  display: flex;
  gap: 0.5rem;
}

.quick-btn {
  background: none;
  border: none;
  color: var(--secondary);
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 6px;
  transition: var(--transition);
  font-size: 0.9rem;
}

.quick-btn:hover {
  background: white;
  color: var(--primary);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

/* Load More */
.load-more {
  text-align: center;
  margin-top: 2rem;
}

/* Buttons */
.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: var(--radius);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

.btn-secondary {
  background: var(--secondary);
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-outline {
  background: transparent;
  border: 2px solid var(--border);
  color: var(--secondary);
}

.btn-outline:hover {
  border-color: var(--primary);
  color: var(--primary);
  background: rgba(67, 97, 238, 0.05);
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: var(--radius);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow: hidden;
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  color: var(--dark);
}

.close-modal {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--secondary);
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: var(--transition);
}

.close-modal:hover {
  background: var(--light);
  color: var(--danger);
}

.modal-body {
  padding: 1.5rem;
}

.modal-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

/* Form Styles */
.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--dark);
}

.form-control {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  font-size: 1rem;
  transition: var(--transition);
  font-family: inherit;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.form-control:read-only {
  background: var(--light);
  cursor: not-allowed;
}

/* Responsive Design */
@media (max-width: 768px) {
  .header-content,
  .messages-content {
    padding: 0 1rem;
  }

  .page-title {
    font-size: 2rem;
  }

  .header-stats {
    grid-template-columns: 1fr;
  }

  .messages-toolbar {
    flex-direction: column;
    align-items: stretch;
  }

  .search-box {
    min-width: auto;
  }

  .messages-grid {
    grid-template-columns: 1fr;
  }

  .modal-content {
    width: 95%;
    margin: 1rem;
  }

  .modal-footer {
    flex-direction: column;
  }

  .card-header {
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
  }

  .message-actions {
    align-self: flex-end;
  }
}

@media (max-width: 480px) {
  .page-title {
    font-size: 1.75rem;
  }

  .student-info {
    flex-direction: column;
    text-align: center;
    gap: 0.75rem;
  }

  .card-footer {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }

  .message-meta {
    justify-content: center;
  }

  .quick-actions {
    justify-content: center;
  }
}
</style>

<script>
// Modal functionality
const replyModal = document.getElementById('replyModal');

function openReplyModal(studentName, messageId) {
  document.getElementById('replyTo').value = studentName;
  replyModal.style.display = 'flex';
}

function closeReplyModal() {
  replyModal.style.display = 'none';
  document.getElementById('replyForm').reset();
}

function sendReply() {
  const message = document.querySelector('#replyForm textarea').value;
  if (message.trim()) {
    // Simulate sending reply
    showNotification('Reply sent successfully!', 'success');
    closeReplyModal();
  } else {
    showNotification('Please enter a message', 'error');
  }
}

// Message actions
function replyToMessage(studentName, messageId) {
  openReplyModal(studentName, messageId);
}

function quickReply(messageId) {
  // Quick reply implementation
  showNotification('Opening quick reply...', 'info');
}

function markAsRead(messageId) {
  const messageCard = document.querySelector(`[data-message-id="${messageId}"]`);
  if (messageCard) {
    messageCard.style.opacity = '0.7';
    showNotification('Message marked as read', 'success');
  }
}

function saveMessage(messageId) {
  showNotification('Message saved', 'success');
}

function deleteMessage(messageId) {
  if (confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
    const messageCard = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageCard) {
      messageCard.style.transform = 'scale(0.8)';
      messageCard.style.opacity = '0';
      setTimeout(() => {
        messageCard.remove();
        // Update stats
        updateMessageStats();
      }, 300);
    }
    showNotification('Message deleted', 'success');
  }
}

// Search and filter functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const messageCards = document.querySelectorAll('.message-card');
  
  messageCards.forEach(card => {
    const text = card.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
});

document.getElementById('filterSelect').addEventListener('change', function(e) {
  // Filter implementation based on selected value
  showNotification(`Filtered by: ${e.target.value}`, 'info');
});

// Refresh functionality
document.getElementById('refreshBtn').addEventListener('click', function() {
  this.classList.add('rotating');
  setTimeout(() => {
    this.classList.remove('rotating');
    showNotification('Messages refreshed', 'success');
  }, 1000);
});

// Load more functionality
document.getElementById('loadMoreBtn').addEventListener('click', function() {
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
  setTimeout(() => {
    this.innerHTML = '<i class="fas fa-chevron-down"></i> Load More Messages';
    showNotification('No more messages to load', 'info');
  }, 1500);
});

// Notification system
function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div class="notification-content">
      <i class="fas fa-${getNotificationIcon(type)}"></i>
      <span>${message}</span>
    </div>
  `;
  
  // Add notification styles if not already added
  if (!document.querySelector('#notification-styles')) {
    const styles = document.createElement('style');
    styles.id = 'notification-styles';
    styles.textContent = `
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 1rem 1.5rem;
        min-width: 300px;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        z-index: 1001;
        border-left: 4px solid;
      }
      
      .notification-success {
        border-left-color: var(--success);
      }
      
      .notification-error {
        border-left-color: var(--danger);
      }
      
      .notification-info {
        border-left-color: var(--primary);
      }
      
      .notification-content {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        color: var(--dark);
        font-weight: 600;
      }
      
      .notification.show {
        transform: translateX(0);
      }
    `;
    document.head.appendChild(styles);
  }
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);
  
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      notification.remove();
    }, 300);
  }, 3000);
}

function getNotificationIcon(type) {
  const icons = {
    success: 'check-circle',
    error: 'exclamation-circle',
    info: 'info-circle'
  };
  return icons[type] || 'info-circle';
}

function updateMessageStats() {
  // Update the message count in stats
  const messageCount = document.querySelectorAll('.message-card').length;
  const statNumbers = document.querySelectorAll('.stat-number');
  if (statNumbers.length > 0) {
    statNumbers[0].textContent = messageCount;
    statNumbers[1].textContent = messageCount; // Update unread count as well
  }
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
  if (event.target === replyModal) {
    closeReplyModal();
  }
});

// Add rotation animation for refresh button
const style = document.createElement('style');
style.textContent = `
  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .rotating {
    animation: rotate 1s linear;
  }
`;
document.head.appendChild(style);

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  // Add any initialization code here
  console.log('Messages page loaded');
});
</script>

{% endblock %}